/**
 * om midi v3.0
 * 简称 OMM，After Effects 的音 MAD / YTPMV 辅助脚本。它是一个能够自动将 MIDI 文件转换为 After Effects 中关键帧的脚本。
 * 希望在 om midi 的帮助下，可以把人们从枯燥繁重的音画对齐中解救出来，把更多的精力投入到更有创造性的工作中。
 *
 * 描述：读取一个 MIDI 序列，并为当前合成添加一个或多个新图层，其中包含各个 MIDI 轨道的音高、力度和持续时间等滑块控件。
 *
 * 脚本原作者：大卫·范·布林克 (omino)、Dora (NGDXW)、韩琦、家鳖大帝
 * 脚本作者：兰音
 *
 * 在此处获取最新版：https://github.com/otomad/om_midi/releases/latest
 * 仓库地址：https://github.com/otomad/om_midi
 *
 * 构建日期：2022 年 9 月 7 日 星期三 上午 10:15:11
 * Copyright (c) 2022 ~, Ranne
 *
 * 原作者介绍：
 * 日期：2011 年 12 月 25 日 星期日 晚上 22:58:10 太平洋时间
 * 作者：大卫·范·布林克
 *
 * 此脚本是 omino Adobe 脚本套件的一部分。
 * 我写这些是因为我喜欢。请尽情享受。
 * 向 poly@omino.com 提出问题，主题行应以“插件”开头，以便我的垃圾邮件过滤器允许它。
 * 此文件已被预处理为独立脚本。我针对一些可重用的库开发它们⸺例如对话框布局⸺但对于分发来说，最好只有一个文件。
 * 大卫·范·布林克 2007。
 *
 * ****************************************************************************************************
 *
 * om midi v3.0
 * Or OMM for short, an Otomad/YTPMV assistant script for After Effects. It is a script that automatically
 * converts MIDI files to keyframes in After Effects. Hope that with the help of om midi, people can be
 * rescued from tedious aligning video and audio, and put more energy into more creative works.
 *
 * Description: This After Effects script reads a Standard MIDI file (.mid)
 * and creates layers and keyframes corresponding to the notes and controllers in that MIDI file.
 *
 * Script Original Authors: David Van Brink (omino), Dora (NGDXW), HanceyMica, Z4HD
 * Script Author: Ranne
 *
 * Get the Latest Version Here: https://github.com/otomad/om_midi/releases/latest
 * Repository Link: https://github.com/otomad/om_midi
 *
 * Building Date: Wednesday, September 7, 2022 10:15 AM
 * Copyright (c) 2022 ~, Ranne
 *
 * Introduction by the Original Author:
 * Date: Sunday, December 25, 2011 10:58 PM PST
 * Author: David Van Brink
 * This script is part of the omino adobe script suite.
 *
 * I write these because I like to. Please enjoy as you see fit.
 *
 * Questions to poly@omino.com, subject line should start with "plugins" so my spam filter lets it in.
 *
 * This file has been preprocessed to be standalone. I develop them against some reusable libraries
 * ⸺ such as for dialog layout ⸺ but for distribution it's nicer to have just one file.
 * dvb 2007.
 */

!function(e){var t={scriptName:"om midi",version:"3.0",githubPage:"https://github.com/otomad/om_midi",githubLatest:"https://github.com/otomad/om_midi/releases/latest"};function i(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function n(e,t,n,r){var o;if("group"==t)o=e.add(t,void 0,r);else if("progressbar"==t)o=e.add(t,void 0,void 0,void 0,r);else if("scrollbar"==t||"slider"==t)o=e.add(t,void 0,void 0,void 0,void 0,r);else o=e.add(t,void 0,void 0,r);var a=o;if(null!=n)for(var l in n)if(i(n,l))a[l]=n[l];return a}function r(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var n=e.items.length?e.getSelectedIndex():0;e.removeAll();for(var r=0,o=t;r<o.length;r++){var a=o[r];e.add("item",a)}return e.selection=n,e}function o(e,t,i,r,o){var a=n(e,"group",{orientation:"row",spacing:7,alignment:"fill",alignChildren:"fill"}),l=function(e,t){var i=n(e,"statictext",{text:t});return function(e){e.minimumSize=[60,Number.MAX_VALUE]}(i),i}(a,t),s=void 0;if(i)s=n(a,i,r,o);return{group:a,label:l,control:s}}var a=function(e,t){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i))e[i]=t[i]},a(e,t)};function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function s(e,t,i){if(i||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)if(n||!(r in t)){if(!n)n=Array.prototype.slice.call(t,0,r);n[r]=t[r]}return e.concat(n||Array.prototype.slice.call(t))}var c={ok:"OK",cancel:"Cancel",channel_abbr:"CH",error:"Error",warning:"Warning",apply:"Apply",settings:"Settings",select_all:"Select all",channel:"Channel",name:"name",note_count:"Note count",language:"Language",general:"General",app_default:"App Default",tools:"Tools",create_null_object_short:"Null",create_null_object:"Create Null Object",apply_effects_short:"Effects",apply_effects:"Apply Effects",marker_conductor:"Marker Conductor",easing_100_percent:"Easing 100%",unit:"Unit",time:"Time",frames:"Frames",seconds:"Seconds",beat:"Beat",shift_seconds_and_frames:"Shift",mark_on:"Mark on",add_null_layer:"Add null layer",current_layer:"Current layer",ease_in:"Ease in",ease_out:"Ease out",ease_in_out:"Ease in out",midi_track_selector_title:"Select MIDI tracks",select_at_least_one_track:"Please select at least one track.",no_midi_file_selected:"No MIDI file selected",select_midi_file:"MIDI",select_midi_track:"Track",set_midi_bpm:"BPM",start_time:"Start time",display_start_time:"Display start time",current_time:"Current time",work_area:"Work area",select_a_midi_file:"Select a MIDI Sequence",midi_files:"MIDI Sequence",all_files:"All Files",check_update:"Check for updates",repository_link:"Repository link",about_script_engine:"About ExtendScript engine",import_om_utils:"Import om utils",import_pure_quarter_midi:"Import pure quarter MIDI",using_selected_layer_name:"Use selected layer name instead of MIDI track name.",normalize_pan_to_100:"Normalize the pan to -100 ~ 100.",using_layering:"@Koorihato Sakuno's unique layering method.",optimize_apply_effects:"Optimize some effects visual.",add_to_effect_transform:"Add the properties to an effect called Transform.",sure_to_import_pure_quarter_midi:"Are you sure you want to import the pure quarter notes MIDI file?",pure_quarter_midi:"Pure quarter notes MIDI",add_at_top_of_expression:"Prepend to expressions",om_utils_same_as_project_directory:"If placed in the same directory as the aep project",om_utils_added_to_project:"If placed anywhere, and then add to AE project",pitch:"Pitch",velocity:"Velocity",duration:"Duration",scale:"Scale",cw_rotation:"Clockwise Rotation",ccw_ratation:"Counterclockwise Rotation",count:"Count",bool:"Bool",time_remap:"Time Remap",pingpong:"Ping-pong",note_on:"Note On",channel_pan:"Channel Pan",channel_volume:"Channel Volume",channel_glide:"Channel Glide",horizontal_flip:"Horizontal Flip",invert_color:"Invert Color",tuning:"Tuning",base_pitch:"Base pitch",paren_stretched:"(Stretched)",paren_truncated:"(Truncated)",cannot_find_window_error:"Error: Unable to find or create window.",unsupported_setting_type_error:"Error: Unsupported setting data type.",file_unreadable_error:"Error: Could not read the MIDI file. The file may already be occupied or not exist.",midi_header_validation_error:"Error: MIDI file header chunks validation failed (not a standard MIDI file or this file is corrupt).",midi_track_header_validation_error:"Error: MIDI track header chunks validation failed.",midi_custom_events_error:"Error: Custom MIDI events could not be read.",midi_no_track_error:"Error: This MIDI file does not contain any valid tracks.",not_after_effects_error:"Error: Please use this script on Adobe After Effects.",cannot_create_file_error:"Error: Could not create file.",cannot_find_composition_error:"Error: Could not find an active composition. Please activate a composition first.\n\nSolution: Open a composite first, then click on the composite preview or track window to make it active.",no_midi_error:"Error: Please open a valid MIDI file first.",no_options_checked_error:"Error: Please check at least one option.",no_layer_selected_error:"Error: No layers are selected in the current composition.",not_one_track_for_apply_effects_only_error:"Error: Applying effects can only select one MIDI track at one time.",end_of_track_position_error:"Error: Track ends in wrong position. Expected %1, actually %2.",cannot_set_time_remap_error:"Error: Time remapping cannot be set for the selected layer.",cannot_tuning_error:"Error: The selected layer does not contain audio so that cannot be tuned.",about:"It reads a Standard MIDI sequence file and creates layers and keyframes corresponding to the notes and controllers in that MIDI sequence file.\n\nScript Original Authors: David Van Brink (omino), Dora (NGDXW), HanceyMica, Z4HD\nScript Author: Ranne\nRepository Link: %1",horizontal_mirror:"Horizontal Mirror",advanced_scale:"Advanced Scale"},u={ok:"OK",cancel:"キャンセル",channel_abbr:"チャネル",error:"エラー",warning:"警告",apply:"適用",settings:"設定",select_all:"すべて選択",channel:"チャネル",name:"名",note_count:"音符の数",language:"言語",general:"一般",app_default:"アプリのデフォルト",tools:"ツール",create_null_object_short:"ヌル",create_null_object:"ヌル オブジェクトを作成",apply_effects_short:"効果を適用",apply_effects:"効果を適用",marker_conductor:"マーカー司令官",easing_100_percent:"イージング百パーセント",unit:"単位",time:"時間",frames:"フレーム",seconds:"秒数",beat:"拍子",shift_seconds_and_frames:"シフト",mark_on:"どこ",add_null_layer:"ヌルレイヤーを追加",current_layer:"現在のレイヤー",ease_in:"イーズイン",ease_out:"イーズアウト",ease_in_out:"イーズインアウト",midi_track_selector_title:"MIDI トラックを選択",select_at_least_one_track:"少なくとも 1 つのトラックを選択してください。",no_midi_file_selected:"MIDI が選択されていない",select_midi_file:"MIDI",select_midi_track:"トラック",set_midi_bpm:"BPM",start_time:"開始時刻",display_start_time:"表示開始時刻",current_time:"現在の時刻",work_area:"作業エリア",select_a_midi_file:"MIDI シーケンスを選択する",midi_files:"MIDI シーケンス",all_files:"全ファイル",check_update:"アップデートを確認",repository_link:"リポジトリ リンク",about_script_engine:"スクリプトエンジンについて",import_om_utils:"om utilsをインポート",import_pure_quarter_midi:"純粋な4分MIDIをインポート",using_selected_layer_name:"MIDI トラック名の代わりに、選択したレイヤー名を使用します。",normalize_pan_to_100:"パンを -100~100 に正規化します。",using_layering:"@氷鳩さくのの特有なレイヤリング方法。",optimize_apply_effects:"一部のエフェクトのビジュアルを最適化。",add_to_effect_transform:"変換という効果にプロパティを追加します。",sure_to_import_pure_quarter_midi:"純粋な 4 分音符 MIDI ファイルをインポートしてもよろしいですか？",pure_quarter_midi:"純粋な 4 分音符 MIDI",add_at_top_of_expression:"式の先頭に追加",om_utils_same_as_project_directory:"AEP プロジェクトと同じディレクトリに配置する場合",om_utils_added_to_project:"任意の場所に配置し、AE プロジェクトに追加する場合",pitch:"ピッチ",velocity:"ヴェロシティ",duration:"持続時間",scale:"スケール",cw_rotation:"右回り",ccw_ratation:"左回り",count:"カウント",bool:"ブール",time_remap:"時間リマップ",pingpong:"ピンポン",note_on:"音符オン",channel_pan:"チャンネルパン",channel_volume:"チャンネル音量",channel_glide:"チャンネルポルタメント",horizontal_flip:"水平方向にフリップ",invert_color:"色を反転",tuning:"色を反転",base_pitch:"ベースピッチ",paren_stretched:"（ストレッチ）",paren_truncated:"（切り捨て）",cannot_find_window_error:"エラー: ウィンドウが見つからないか作成できません。",unsupported_setting_type_error:"エラー: サポートされていないセット データ型です。",file_unreadable_error:"エラー: MIDI ファイルを読み取れませんでした。ファイルが既に占有されているか、存在しない可能性があります。",midi_header_validation_error:"エラー: MIDI ファイル ヘッダー チャンクの検証に失敗しました（標準の MIDI ファイルではないか、ファイルが破損しています）。",midi_track_header_validation_error:"エラー: MIDI トラック ヘッダー チャンクの検証に失敗しました。",midi_custom_events_error:"エラー: カスタム MIDI イベントを読み取れませんでした。",midi_no_track_error:"エラー: MIDI ファイルに有効なトラックが含まれていません。",not_after_effects_error:"エラー: Adobe After Effects でこのスクリプトを使用してください。",cannot_create_file_error:"エラー: ファイルを作成できませんでした。",cannot_find_composition_error:"エラー: アクティブな構成が見つかりません。最初にコンポジションをアクティブにしてください。\n\n解決策: まずコンポジットを開き、コンポジット プレビューまたはトラック ウィンドウをクリックしてアクティブにします。",no_midi_error:"エラー: 最初に有効な MIDI ファイルを開いてください。",no_options_checked_error:"エラー: 少なくとも 1 つのオプションをオンにしてください。",no_layer_selected_error:"エラー: 現在のコンポジションでレイヤーが選択されていません。",not_one_track_for_apply_effects_only_error:"エラー: エフェクトを適用すると、一度に選択できる MIDI トラックは 1 つだけです。",end_of_track_position_error:"エラー: トラックの終了位置が間違っています。期待される %1、実際には %2。",cannot_set_time_remap_error:"エラー: 選択したレイヤーにタイム リマップを設定できません。",cannot_tuning_error:"エラー: 選択したレイヤーにはオーディオが含まれていないため、調整できません。",about:"標準 MIDI ファイルを読み取り、その MIDI ファイル内のノートとコントローラーに対応するレイヤーとキーフレームを作成します。\n\n脚本原作者：デビッド・ヴァン・ブリンク（オミノ）、ドラ (NGDXW)、韓琦、家鼈大帝\n脚本作者：蘭音\nリポジトリ リンク：%1",horizontal_mirror:"水平方向のミラー",advanced_scale:"高度なスケール"},_={ok:"确定",cancel:"取消",channel_abbr:"通道",error:"错误",warning:"警告",apply:"应用",settings:"设置",select_all:"全选",channel:"通道",name:"名称",note_count:"音符数",language:"语言",general:"通用",app_default:"应用默认值",tools:"工具",create_null_object_short:"空对象",create_null_object:"创建空对象",apply_effects_short:"应用效果",apply_effects:"应用效果",marker_conductor:"标记指挥官",easing_100_percent:"缓动百分百",unit:"单位",time:"时间",frames:"帧数",seconds:"秒数",beat:"节拍",shift_seconds_and_frames:"偏移",mark_on:"标记在",add_null_layer:"新建空对象图层",current_layer:"当前图层",ease_in:"缓入",ease_out:"缓出",ease_in_out:"缓入缓出",midi_track_selector_title:"选择 MIDI 轨道",select_at_least_one_track:"请至少选择一条轨道。",no_midi_file_selected:"未选择 MIDI 文件",select_midi_file:"MIDI 文件",select_midi_track:"选择轨道",set_midi_bpm:"设定 BPM",start_time:"开始时间",display_start_time:"显示开始时间",current_time:"当前时间",work_area:"工作区域",select_a_midi_file:"选择一个 MIDI 序列",midi_files:"MIDI 序列",all_files:"所有文件",check_update:"检查更新",repository_link:"仓库地址",about_script_engine:"关于脚本引擎",import_om_utils:"导入 om utils",import_pure_quarter_midi:"导入纯四分 MIDI",using_selected_layer_name:"使用选中图层名称而不是 MIDI 轨道名称。",normalize_pan_to_100:"声像标准化到 -100 ~ 100。",using_layering:"@冰鸠さくの的特有图层叠叠乐方法。",optimize_apply_effects:"优化部分效果视觉。",add_to_effect_transform:"将属性添加到效果中的变换中。",sure_to_import_pure_quarter_midi:"确定要导入纯四分音符 MIDI 文件吗？",pure_quarter_midi:"纯四分音符 MIDI",add_at_top_of_expression:"在表达式顶部添加",om_utils_same_as_project_directory:"若放置在 aep 项目的相同目录下",om_utils_added_to_project:"若放置在任意位置，然后添加到 AE 项目中",pitch:"音高",velocity:"力度",duration:"持续时间",scale:"缩放",cw_rotation:"顺时针旋转",ccw_ratation:"逆时针旋转",count:"计数",bool:"布尔",time_remap:"时间重映射",pingpong:"来回",note_on:"音符开",channel_pan:"通道声像",channel_volume:"通道音量",channel_glide:"通道弯音",horizontal_flip:"水平翻转",invert_color:"颜色反转",tuning:"调音",base_pitch:"原始音高",paren_stretched:"（拉伸）",paren_truncated:"（截断）",cannot_find_window_error:"错误：无法找到或创建窗口。",unsupported_setting_type_error:"错误：不支持的设置数据类型。",file_unreadable_error:"错误：无法读取 MIDI 文件。该文件可能已占用或不存在。",midi_header_validation_error:"错误：MIDI 文件头验证失败（不是标准 MIDI 文件或文件已损坏）。",midi_track_header_validation_error:"错误：MIDI 轨道块标头验证失败。",midi_custom_events_error:"错误：自定义 MIDI 事件无法读取。",midi_no_track_error:"错误：该 MIDI 文件不包含任何有效轨道。",not_after_effects_error:"错误：请在 Adobe After Effects 上使用此脚本。",cannot_create_file_error:"错误：无法创建文件。",cannot_find_composition_error:"错误：无法找到活动合成。请先激活一个合成。\n\n解决方法：请先打开一个合成，然后点击一下该合成的预览画面或轨道的窗口使之处于活跃状态即可。",no_midi_error:"错误：请先打开一个有效的 MIDI 文件。",no_options_checked_error:"错误：请至少勾选一个项目。",no_layer_selected_error:"错误：在当前合成中未选中任何图层。",not_one_track_for_apply_effects_only_error:"错误：应用效果只能同时选择一条轨道。",end_of_track_position_error:"错误：轨道结束位置有误。应为 %1，实际 %2。",cannot_set_time_remap_error:"错误：所选图层不能设置时间重映射。",cannot_tuning_error:"错误：所选图层不包含音频，不能进行调音。",about:"读取一个 MIDI 序列，并为当前合成添加一个或多个新图层，其中包含各个 MIDI 轨道的音高、力度和持续时间等滑块控件。\n\n脚本原作者：大卫·范·布林克 (omino)、Dora (NGDXW)、韩琦、家鳖大帝\n脚本作者：兰音\n仓库地址：%1",horizontal_mirror:"水平镜像",advanced_scale:"高级缩放"},p={};for(var h in _)if(i(_,h))p[h]={zh:_[h],en:c[h],ja:u[h]};var f,d="...",m={orientation:"column",alignment:["fill","top"],alignChildren:"fill",spacing:2,margins:[10,5,10,0]},E=function(){function e(e,t,i){if(void 0===i)i=m;this.parent=e,this.tab=n(this.parent.tabs,"tab",{text:t}),this.group=n(this.tab,"group",i)}return e.prototype.getCheckedChecks=function(){for(var e=[],t=0,i=this.group.children;t<i.length;t++){var n=i[t];if(n instanceof Checkbox&&n.value)e.push(n)}return e},e.prototype.addCheckbox=function(e){return n(this.group,"checkbox",{text:e,alignment:["fill","fill"]})},e}(),O=function(e){function t(t){var i=e.call(this,t)||this;return i.pitch=i.addCheckbox(),i.velocity=i.addCheckbox(),i.duration=i.addCheckbox(),i.scale=i.addCheckbox(),i.advancedScale=i.addCheckbox(),i.cwRotation=i.addCheckbox(),i.ccwRotation=i.addCheckbox(),i.count=i.addCheckbox(),i.bool=i.addCheckbox(),i.timeRemap=i.addCheckbox(),i.pingpong=i.addCheckbox(),i.noteOn=i.addCheckbox(),i.pan=i.addCheckbox(),i.volume=i.addCheckbox(),i.glide=i.addCheckbox(),i}return l(t,e),t.prototype.translate=function(){this.tab.text=localize(p.create_null_object_short),this.pitch.text=localize(p.pitch),this.velocity.text=localize(p.velocity),this.duration.text=localize(p.duration),this.scale.text=localize(p.scale),this.advancedScale.text=localize(p.advanced_scale),this.cwRotation.text=localize(p.cw_rotation),this.ccwRotation.text=localize(p.ccw_ratation),this.count.text=localize(p.count),this.bool.text=localize(p.bool),this.timeRemap.text=localize(p.time_remap),this.pingpong.text=localize(p.pingpong),this.noteOn.text=localize(p.note_on),this.pan.text=localize(p.channel_pan),this.volume.text=localize(p.channel_volume),this.glide.text=localize(p.channel_glide)},t}(E),T=function(e){function t(t){var i,a=e.call(this,t)||this;return a.timeRemap=a.addCheckbox(),a.timeRemap2=a.addCheckbox(),a.pingpong=a.addCheckbox(),a.hFlip=a.addCheckbox(),a.hMirror=a.addCheckbox(),a.cwRotation=a.addCheckbox(),a.ccwRotation=a.addCheckbox(),a.negative=a.addCheckbox(),a.tuning=a.addCheckbox(),i=o(a.group,"","dropdownlist"),a.basePitchGroup=i.group,a.basePitchLbl=i.label,a.basePitchKeyCombo=i.control,a.basePitchOctCombo=n(a.basePitchGroup,"dropdownlist"),r.apply(void 0,s([a.basePitchKeyCombo],"C,C#,D,D#,E,F,F#,G,G#,A,A#,B".split(","))),r.apply(void 0,s([a.basePitchOctCombo],"0,1,2,3,4,5,6,7,8,9,10".split(","))),a.basePitchOctCombo.selection=5,a.basePitchGroup.enabled=!1,a.tuning.onClick=function(){return a.basePitchGroup.enabled=a.tuning.value},a.cwRotation.onClick=function(){return a.ccwRotation.value=!1},a.ccwRotation.onClick=function(){return a.cwRotation.value=!1},a.timeRemap.onClick=function(){return a.timeRemap2.value=a.pingpong.value=!1},a.timeRemap2.onClick=function(){return a.timeRemap.value=a.pingpong.value=!1},a.pingpong.onClick=function(){return a.timeRemap.value=a.timeRemap2.value=!1},a}return l(t,e),t.prototype.translate=function(){this.tab.text=localize(p.apply_effects_short),this.basePitchLbl.text=localize(p.base_pitch),this.timeRemap.text=localize(p.time_remap)+localize(p.paren_stretched),this.timeRemap2.text=localize(p.time_remap)+localize(p.paren_truncated),this.pingpong.text=localize(p.pingpong),this.hFlip.text=localize(p.horizontal_flip),this.hMirror.text=localize(p.horizontal_mirror),this.cwRotation.text=localize(p.cw_rotation),this.ccwRotation.text=localize(p.ccw_ratation),this.negative.text=localize(p.invert_color),this.tuning.text=localize(p.tuning)},t}(E);function g(e,t,i){e.onChange=function(){var n=e.text,r=/\d+/g;if(t===f.POSITIVE_DECIMAL)r=/\d+(\.\d+)?/g;else if(t===f.DECIMAL)r=/-?\d+(\.\d+)?/g;var o=n.match(r);if(o){(n=o[0].replace(/^0+(?!\.)/g,""))||(n="0");var a=t==f.POSITIVE_INT?parseInt(n,10):parseFloat(n);n=String(t!==f.DECIMAL&&a<=0||isNaN(a)?i:a)}else n=String(i);e.text=n}}!function(e){e[e.POSITIVE_INT=0]="POSITIVE_INT",e[e.POSITIVE_DECIMAL=1]="POSITIVE_DECIMAL",e[e.DECIMAL=2]="DECIMAL"}(f||(f={}));var R=function(e){this.parent=e,this.group=n(this.parent.toolsPanel,"group",{orientation:"column",alignment:["fill","fill"],alignChildren:"fill",spacing:2})},y=function(e){function t(t){var i,n,r,a,l=e.call(this,t)||this,s=["fill","center"];return i=o(l.group,"","dropdownlist",{alignment:s}),l.unitGroup=i.group,l.unitLbl=i.label,l.unitCombo=i.control,n=o(l.group,"BPM","edittext",{text:"120",alignment:s}),l.bpmGroup=n.group,l.bpmLbl=n.label,l.bpmTxt=n.control,r=o(l.group,"","edittext",{text:"4",alignment:s}),l.beatGroup=r.group,l.beatLbl=r.label,l.beatTxt=r.control,a=o(l.group,"","dropdownlist",{alignment:s}),l.markOnGroup=a.group,l.markOnLbl=a.label,l.markOnCombo=a.control,l.translate(),g(l.bpmTxt,f.POSITIVE_DECIMAL,120),l.unitCombo.onChange=function(){var e=l.unitCombo.getSelectedIndex();l.beatLbl.text=0===e?localize(p.beat):localize(p.shift_seconds_and_frames),l.bpmLbl.text=0===e?"BPM":1===e?localize(p.seconds):localize(p.frames),g(l.beatTxt,0===e?f.POSITIVE_INT:f.DECIMAL,4),l.beatTxt.notify("onChange")},l.unitCombo.notify("onChange"),l}return l(t,e),t.prototype.translate=function(){this.unitLbl.text=localize(p.unit),this.markOnLbl.text=localize(p.mark_on),r(this.unitCombo,"BPM",localize(p.time),localize(p.frames)),r(this.markOnCombo,localize(p.add_null_layer),localize(p.current_layer))},t}(R),L=function(e,t){this.control=e.add("panel"),this.control.alignment="horizontal"===t?["fill","top"]:["center","fill"]},S=function(e){function t(t){var i=this;if("string"==typeof t||!("isMyError"in t))alert(t.toString(),localize(p.error),!0);return(i=e.call(this,t.toString())||this).isMyError=!0,i}return l(t,e),t}(Error),v=function(e){function t(){return e.call(this,localize(p.cannot_find_window_error))||this}return l(t,e),t}(S),C=function(e){function t(){return e.call(this,localize(p.unsupported_setting_type_error))||this}return l(t,e),t}(S),N=function(e){function t(){return e.call(this,localize(p.file_unreadable_error))||this}return l(t,e),t}(S),b=function(e){function t(){return e.call(this,localize(p.midi_header_validation_error))||this}return l(t,e),t}(S),I=function(e){function t(){return e.call(this,localize(p.midi_track_header_validation_error))||this}return l(t,e),t}(S),A=function(e){function t(){return e.call(this,localize(p.midi_custom_events_error))||this}return l(t,e),t}(S),k=function(e){function t(){return e.call(this,localize(p.midi_no_track_error))||this}return l(t,e),t}(S),w=function(e){function t(){return e.call(this,localize(p.not_after_effects_error))||this}return l(t,e),t}(S),D=function(e){function t(){return e.call(this,localize(p.cannot_create_file_error))||this}return l(t,e),t}(S),P=function(e){function t(){return e.call(this,localize(p.cannot_find_composition_error))||this}return l(t,e),t}(S),M=function(e){function t(){return e.call(this,localize(p.no_midi_error))||this}return l(t,e),t}(S),x=function(e){function t(){return e.call(this,localize(p.no_options_checked_error))||this}return l(t,e),t}(S),B=function(e){function t(){return e.call(this,localize(p.no_layer_selected_error))||this}return l(t,e),t}(S),F=function(e){function t(){return e.call(this,localize(p.not_one_track_for_apply_effects_only_error))||this}return l(t,e),t}(S),z=function(e){function t(t,i){return e.call(this,localize(p.end_of_track_position_error,t,i))||this}return l(t,e),t}(S),G=function(e){function t(){return e.call(this,localize(p.cannot_set_time_remap_error))||this}return l(t,e),t}(S),U=function(e){function t(){return e.call(this,localize(p.cannot_tuning_error))||this}return l(t,e),t}(S);var K,H,V,j,Y="om_midi",X=function(e,t){if(!app.settings.haveSetting(Y,e))return t;else{var i=app.settings.getSetting(Y,e),n=void 0;if("string"==typeof t)n=i;else if("number"==typeof t)n=Number(i);else if("boolean"==typeof t)n="0"!==i;else throw new C;return n}},q=function(e,t){var i=t;if("boolean"==typeof t)i=i?"1":"0";app.settings.saveSetting(Y,e,i.toString())},W={Language:0,UsingSelectedLayerName:!1,UsingLayering:!1,OptimizeApplyEffects:!0,NormalizePanTo100:!0,AddToEffectTransform:!1,ApplyEffectsStartTime:1,NullObjectStartTime:0,LastTool:0},Q={},Z=function(e){if(i(W,e))Q["get"+e]=function(t){if(void 0===t)t=W[e];return X(e,t)},Q["set"+e]=function(t){return q(e,t)}};for(var J in W)Z(J);!function(e){e[e.SINGLE_TRACK=0]="SINGLE_TRACK",e[e.SYNC_MULTI_TRACK=1]="SYNC_MULTI_TRACK",e[e.ASYNC_MULTI_TRACK=2]="ASYNC_MULTI_TRACK"}(K||(K={})),function(e){e[e.END_OF_TRACK=47]="END_OF_TRACK",e[e.END_OF_FILE=-1]="END_OF_FILE",e[e.TEXT_EVENT=1]="TEXT_EVENT",e[e.COPYRIGHT_NOTICE=2]="COPYRIGHT_NOTICE",e[e.TRACK_NAME=3]="TRACK_NAME",e[e.INSTRUMENT_NAME=4]="INSTRUMENT_NAME",e[e.LYRICS=5]="LYRICS",e[e.MARKER=6]="MARKER",e[e.CUE_POINT=7]="CUE_POINT",e[e.MIDI_PORT=33]="MIDI_PORT",e[e.MIDI_PORT_2=32]="MIDI_PORT_2",e[e.SET_TEMPO=81]="SET_TEMPO",e[e.KEY_SIGNATURE=89]="KEY_SIGNATURE",e[e.SMPTE_OFFSET=84]="SMPTE_OFFSET",e[e.TIME_SIGNATURE=88]="TIME_SIGNATURE",e[e.SEQUENCER_SPECIFIC=127]="SEQUENCER_SPECIFIC"}(H||(H={})),function(e){e[e.SYSTEM_EXCLUSIVE_EVENTS=15]="SYSTEM_EXCLUSIVE_EVENTS",e[e.NOTE_AFTERTOUCH=10]="NOTE_AFTERTOUCH",e[e.CONTROLLER=11]="CONTROLLER",e[e.PITCH_BEND_EVENT=14]="PITCH_BEND_EVENT",e[e.NOTE_OFF=8]="NOTE_OFF",e[e.NOTE_ON=9]="NOTE_ON",e[e.PROGRAM_CHANGE=12]="PROGRAM_CHANGE",e[e.CHANNEL_AFTERTOUCH=13]="CHANNEL_AFTERTOUCH",e[e.END_OF_FILE=-1]="END_OF_FILE"}(V||(V={})),function(e){e[e.BANK_SELECT=0]="BANK_SELECT",e[e.MODULATION=1]="MODULATION",e[e.BREATH_CONTROLLER=2]="BREATH_CONTROLLER",e[e.FOOT_CONTROLLER=4]="FOOT_CONTROLLER",e[e.PORTAMENTO_TIME=5]="PORTAMENTO_TIME",e[e.DATA_ENTRY=6]="DATA_ENTRY",e[e.MAIN_VOLUME=7]="MAIN_VOLUME",e[e.BALANCE=8]="BALANCE",e[e.PAN=10]="PAN",e[e.EXPRESSION_CONTROLLER=11]="EXPRESSION_CONTROLLER",e[e.EFFECT_CONTROL_1=12]="EFFECT_CONTROL_1",e[e.EFFECT_CONTROL_2=13]="EFFECT_CONTROL_2",e[e.GENERAL_PURPOSE_CONTROLLERS_1=16]="GENERAL_PURPOSE_CONTROLLERS_1",e[e.GENERAL_PURPOSE_CONTROLLERS_2=17]="GENERAL_PURPOSE_CONTROLLERS_2",e[e.GENERAL_PURPOSE_CONTROLLERS_3=18]="GENERAL_PURPOSE_CONTROLLERS_3",e[e.GENERAL_PURPOSE_CONTROLLERS_4=19]="GENERAL_PURPOSE_CONTROLLERS_4",e[e.LSB_FOR_CONTROLLERS_0=32]="LSB_FOR_CONTROLLERS_0",e[e.LSB_FOR_CONTROLLERS_1=33]="LSB_FOR_CONTROLLERS_1",e[e.LSB_FOR_CONTROLLERS_2=34]="LSB_FOR_CONTROLLERS_2",e[e.LSB_FOR_CONTROLLERS_3=35]="LSB_FOR_CONTROLLERS_3",e[e.LSB_FOR_CONTROLLERS_4=36]="LSB_FOR_CONTROLLERS_4",e[e.LSB_FOR_CONTROLLERS_5=37]="LSB_FOR_CONTROLLERS_5",e[e.LSB_FOR_CONTROLLERS_6=38]="LSB_FOR_CONTROLLERS_6",e[e.LSB_FOR_CONTROLLERS_7=39]="LSB_FOR_CONTROLLERS_7",e[e.LSB_FOR_CONTROLLERS_8=40]="LSB_FOR_CONTROLLERS_8",e[e.LSB_FOR_CONTROLLERS_9=41]="LSB_FOR_CONTROLLERS_9",e[e.LSB_FOR_CONTROLLERS_10=42]="LSB_FOR_CONTROLLERS_10",e[e.LSB_FOR_CONTROLLERS_11=43]="LSB_FOR_CONTROLLERS_11",e[e.LSB_FOR_CONTROLLERS_12=44]="LSB_FOR_CONTROLLERS_12",e[e.LSB_FOR_CONTROLLERS_13=45]="LSB_FOR_CONTROLLERS_13",e[e.LSB_FOR_CONTROLLERS_14=46]="LSB_FOR_CONTROLLERS_14",e[e.LSB_FOR_CONTROLLERS_15=47]="LSB_FOR_CONTROLLERS_15",e[e.LSB_FOR_CONTROLLERS_16=48]="LSB_FOR_CONTROLLERS_16",e[e.LSB_FOR_CONTROLLERS_17=49]="LSB_FOR_CONTROLLERS_17",e[e.LSB_FOR_CONTROLLERS_18=50]="LSB_FOR_CONTROLLERS_18",e[e.LSB_FOR_CONTROLLERS_19=51]="LSB_FOR_CONTROLLERS_19",e[e.LSB_FOR_CONTROLLERS_20=52]="LSB_FOR_CONTROLLERS_20",e[e.LSB_FOR_CONTROLLERS_21=53]="LSB_FOR_CONTROLLERS_21",e[e.LSB_FOR_CONTROLLERS_22=54]="LSB_FOR_CONTROLLERS_22",e[e.LSB_FOR_CONTROLLERS_23=55]="LSB_FOR_CONTROLLERS_23",e[e.LSB_FOR_CONTROLLERS_24=56]="LSB_FOR_CONTROLLERS_24",e[e.LSB_FOR_CONTROLLERS_25=57]="LSB_FOR_CONTROLLERS_25",e[e.LSB_FOR_CONTROLLERS_26=58]="LSB_FOR_CONTROLLERS_26",e[e.LSB_FOR_CONTROLLERS_27=59]="LSB_FOR_CONTROLLERS_27",e[e.LSB_FOR_CONTROLLERS_28=60]="LSB_FOR_CONTROLLERS_28",e[e.LSB_FOR_CONTROLLERS_29=61]="LSB_FOR_CONTROLLERS_29",e[e.LSB_FOR_CONTROLLERS_30=62]="LSB_FOR_CONTROLLERS_30",e[e.LSB_FOR_CONTROLLERS_31=63]="LSB_FOR_CONTROLLERS_31",e[e.DAMPER_PEDAL=64]="DAMPER_PEDAL",e[e.PORTAMENTO=65]="PORTAMENTO",e[e.SOSTENUTO=66]="SOSTENUTO",e[e.SOFT_PEDAL=67]="SOFT_PEDAL",e[e.LEGATO_FOOTSWITCH=68]="LEGATO_FOOTSWITCH",e[e.HOLD_2=69]="HOLD_2",e[e.SOUND_CONTROLLER_1=70]="SOUND_CONTROLLER_1",e[e.SOUND_CONTROLLER_2=71]="SOUND_CONTROLLER_2",e[e.SOUND_CONTROLLER_3=72]="SOUND_CONTROLLER_3",e[e.SOUND_CONTROLLER_4=73]="SOUND_CONTROLLER_4",e[e.SOUND_CONTROLLER_5=74]="SOUND_CONTROLLER_5",e[e.SOUND_CONTROLLER_6=75]="SOUND_CONTROLLER_6",e[e.SOUND_CONTROLLER_7=76]="SOUND_CONTROLLER_7",e[e.SOUND_CONTROLLER_8=77]="SOUND_CONTROLLER_8",e[e.SOUND_CONTROLLER_9=78]="SOUND_CONTROLLER_9",e[e.SOUND_CONTROLLER_10=79]="SOUND_CONTROLLER_10",e[e.GENERAL_PURPOSE_CONTROLLERS_5=80]="GENERAL_PURPOSE_CONTROLLERS_5",e[e.GENERAL_PURPOSE_CONTROLLERS_6=81]="GENERAL_PURPOSE_CONTROLLERS_6",e[e.GENERAL_PURPOSE_CONTROLLERS_7=82]="GENERAL_PURPOSE_CONTROLLERS_7",e[e.GENERAL_PURPOSE_CONTROLLERS_8=83]="GENERAL_PURPOSE_CONTROLLERS_8",e[e.PORTAMENTO_CONTROL=84]="PORTAMENTO_CONTROL",e[e.EFFECTS_1_DEPTH=91]="EFFECTS_1_DEPTH",e[e.EFFECTS_2_DEPTH=92]="EFFECTS_2_DEPTH",e[e.EFFECTS_3_DEPTH=93]="EFFECTS_3_DEPTH",e[e.EFFECTS_4_DEPTH=94]="EFFECTS_4_DEPTH",e[e.EFFECTS_5_DEPTH=95]="EFFECTS_5_DEPTH",e[e.DATA_INCREMENT=96]="DATA_INCREMENT",e[e.DATA_DECREMENT=97]="DATA_DECREMENT",e[e.NON_REGISTERED_PARAMETER_NUMBER_LSB=98]="NON_REGISTERED_PARAMETER_NUMBER_LSB",e[e.NON_REGISTERED_PARAMETER_NUMBER_MSB=99]="NON_REGISTERED_PARAMETER_NUMBER_MSB",e[e.REGISTERED_PARAMETER_NUMBER_LSB=100]="REGISTERED_PARAMETER_NUMBER_LSB",e[e.REGISTERED_PARAMETER_NUMBER_MSB=101]="REGISTERED_PARAMETER_NUMBER_MSB",e[e.MODE_MESSAGES_1=121]="MODE_MESSAGES_1",e[e.MODE_MESSAGES_2=122]="MODE_MESSAGES_2",e[e.MODE_MESSAGES_3=123]="MODE_MESSAGES_3",e[e.MODE_MESSAGES_4=124]="MODE_MESSAGES_4",e[e.MODE_MESSAGES_5=125]="MODE_MESSAGES_5",e[e.MODE_MESSAGES_6=126]="MODE_MESSAGES_6",e[e.MODE_MESSAGES_7=127]="MODE_MESSAGES_7"}(j||(j={}));var ee,te=K,ie=function(){this.deltaTime=0,this.sofarTick=0},ne=function(e){function t(t){var i=e.call(this)||this;return i.type=0,i.type=t,i}return l(t,e),t}(ie),re=function(e){function t(t,i){var n=e.call(this,t)||this;return n.content=i,n}return l(t,e),t}(ne),oe=function(e){function t(t,i){var n=e.call(this,t)||this;return n.value=i,n}return l(t,e),t}(ne),ae=function(e){function t(t){var i=e.call(this,H.SMPTE_OFFSET)||this;return i.hour=t[0],i.min=t[1],i.sec=t[2],i.fr=t[3],i.subFr=t[4],i}return l(t,e),t}(ne),le=function(e){function t(t){var i=e.call(this,H.TIME_SIGNATURE)||this;return i.number=t[0],i.denom=t[1],i.metro=t[2],i.thirtySeconds=t[3],i}return l(t,e),t.prototype.toString=function(){return this.number+"/"+Math.pow(2,this.denom)},t}(ne),se=function(e){function t(t,i){var n=e.call(this,t)||this;return n.value=i,n}return l(t,e),t}(ne),ce=function(e){function t(t,i){var n=e.call(this)||this;return n.type=t,n.values=i,n}return l(t,e),t}(ie),ue=function(e){function t(t,i){var n=e.call(this,t,i)||this;return n.pitch=i[0],n.velocity=i[1],n}return l(t,e),t}(ce),_e=function(e){function t(t,i,n,r,o){var a=this;if(t instanceof Array)a=e.call(this,V.NOTE_ON,t)||this;else(a=e.call(this,V.NOTE_ON,[t,i])||this).deltaTime=n,a.duration=r,a.sofarTick=o;return a}return l(t,e),t}(ue),pe=function(e){function t(t){return e.call(this,V.NOTE_OFF,t)||this}return l(t,e),t}(ue),he=function(e){function t(t){return e.call(this,V.SYSTEM_EXCLUSIVE_EVENTS,t)||this}return l(t,e),t}(ce),fe=function(e){function t(t){var i=e.call(this,V.CONTROLLER,t)||this;return i.controller=t[0],i.value=t[1],i}return l(t,e),t}(ce),de=function(e){function t(i){var n=e.call(this,V.PITCH_BEND_EVENT,i)||this;return n.value=t.take7Bit(i[1])<<7|t.take7Bit(i[0]),n}return l(t,e),t.take7Bit=function(e){return 127&e},t}(ce),me=5e-4,Ee="om midi null",Oe="om midi Transform",Te=function(){function e(e){this.portal=e}return e.prototype.apply=function(){var e=function(){var e=app.project.activeItem;if(!isValid(e))return null;else return e}();if(null===e)throw new P;try{var t=this.portal.getSelectedTab();if(t===this.portal.nullObjTab)this.applyCreateNullObject(e);else if(t===this.portal.applyEffectsTab)this.applyEffects(e);else if(t===this.portal.toolsTab){var i=this.portal.toolsTab.getSelectedTool();if(i===this.portal.toolsTab.marker)this.applyMarkerConductor(e);else if(i===this.portal.toolsTab.ease)this.applyEase100Percent(e)}}catch(e){throw new S(e)}finally{app.endUndoGroup()}},e.prototype.applyCreateNullObject=function(e){var t,i,n=this;app.beginUndoGroup("om midi - Apply Create Null Object");var r=this.portal.nullObjTab;if(!this.portal.midi||0===this.portal.selectedTracks.length)throw new M;var o=r.getCheckedChecks();if(0===o.length)throw new x;var a=Q.getUsingSelectedLayerName(),l=this.getSelectLayer(e);if(null===l)a=!1;for(var s=Q.getNormalizePanTo100(),c=this.getSecondsPerTick(),u=this.getStartTime(e),_=function(_){if(void 0===_&&!p.portal.midi.isPureQuarter)return"continue";var h=p.createNullLayer(e);if(void 0!==_)h.name="[midi]"+(a&&null!==l?l.name:null!==(t=_.name)&&void 0!==t?t:"Channel "+(null!==(i=_.channel)&&void 0!==i?i:0));else h.name="[midi]BPM: "+p.portal.selectBpmTxt.text;h.inPoint=u,h.outPoint=void 0!==_?u+_.lengthTick*c:u+e.duration;for(var f=0,d=o;f<d.length;f++){var m=d[f];p.addSliderControl(h,m.text)}var E=function(e,t,i,r,a){return n.setValueAtTime(h,o,e,u+t,i,r,a)},O=0,T=V.NOTE_OFF,g=-1,R=NaN,y=NaN,L=NaN;E(r.velocity,0,0,KeyframeInterpolationType.HOLD),E(r.noteOn,0,0,KeyframeInterpolationType.HOLD),E(r.count,0,0,KeyframeInterpolationType.HOLD),p.dealNoteEvents(_,e,c,u,(function(e){var t,i;if(!(e.sofarTick<=g)||T===V.NOTE_OFF&&e instanceof _e||!(e instanceof _e||e instanceof pe)){var n=e.sofarTick*c;if(e instanceof _e&&0!==e.velocity){if(0===e.interruptDuration||0===e.duration||+e.interruptDuration<0||+e.duration<0)return;if(O++,E(r.pitch,n,e.pitch,KeyframeInterpolationType.HOLD),E(r.velocity,n,e.velocity,KeyframeInterpolationType.HOLD),E(r.duration,n,null!==(t=e.duration)&&void 0!==t?t:0,KeyframeInterpolationType.HOLD),E(r.count,n,O,KeyframeInterpolationType.HOLD),E(r.bool,n,O%2,KeyframeInterpolationType.HOLD),E(r.scale,n,O%2?100:-100,KeyframeInterpolationType.HOLD),E(r.advancedScale,n,O%2?1:-1,KeyframeInterpolationType.HOLD),E(r.cwRotation,n,(O-1)%4*90,KeyframeInterpolationType.HOLD),E(r.ccwRotation,n,(4-(O-1)%4)%4*90,KeyframeInterpolationType.HOLD),E(r.noteOn,n,1,KeyframeInterpolationType.HOLD),E(r.timeRemap,n,0,KeyframeInterpolationType.LINEAR),E(r.pingpong,n,+!(O%2),KeyframeInterpolationType.LINEAR),void 0!==e.interruptDuration||void 0!==e.duration){var o=null!==(i=e.interruptDuration)&&void 0!==i?i:e.duration,a=(e.sofarTick+o)*c-me;E(r.timeRemap,a,1,KeyframeInterpolationType.LINEAR,KeyframeInterpolationType.HOLD),E(r.pingpong,a,O%2,KeyframeInterpolationType.LINEAR,KeyframeInterpolationType.HOLD)}T=V.NOTE_ON,g=e.sofarTick}else if(e instanceof _e&&0===e.velocity||e instanceof pe){a=n-me;E(r.velocity,a,e.velocity,KeyframeInterpolationType.HOLD),E(r.noteOn,n,0,KeyframeInterpolationType.HOLD),T=V.NOTE_OFF,g=e.sofarTick}else if(e instanceof fe){var l=e.controller;if(l===j.PAN){if(R===e.value)return;R=e.value;var u=e.value-64;if(s)if(u<0)u=u/64*100;else if(u>0)u=u/63*100;E(r.pan,n,u,KeyframeInterpolationType.HOLD)}else if(l===j.MAIN_VOLUME){if(y===e.value)return;y=e.value,E(r.volume,n,e.value,KeyframeInterpolationType.HOLD)}}else if(e instanceof de){if(L===e.value)return;L=e.value;var _=e.value-8192;E(r.glide,n,_,KeyframeInterpolationType.HOLD)}}}))},p=this,h=0,f=this.portal.selectedTracks;h<f.length;h++){_(f[h])}},e.prototype.applyMarkerConductor=function(e){app.beginUndoGroup("om midi - Apply Marker Conductor");var t,i=this.portal.toolsTab.marker;if(1===i.markOnCombo.getSelectedIndex()){var n=this.getSelectLayer(e);if(null===n)throw new B;t=n}else(t=this.createNullLayer(e)).name="BPM:"+i.bpmTxt.text+" ("+i.beatTxt.text+"/4)";var r=this.getStartTime(e);t.startTime=r;var o=1,a=i.unitCombo.getSelectedIndex();if(1===a)r-=parseFloat(i.beatTxt.text);else if(2===a)r-=parseFloat(i.beatTxt.text)*e.frameDuration;for(var l=parseFloat(i.bpmTxt.text);r<=e.displayStartTime+e.duration;){if(r>=e.displayStartTime)t.marker.setValueAtTime(r,new MarkerValue(String(o)));if(0===a)o=o%parseInt(i.beatTxt.text)+1,r+=60/l;else if(o++,1===a)r+=l;else if(2===a)r+=l*e.frameDuration}},e.prototype.applyEffects=function(t){var i=this;app.beginUndoGroup("om midi - Apply Effects");var n=this.portal.applyEffectsTab;if(!this.portal.midi||0===this.portal.selectedTracks.length)throw new M;if(0===n.getCheckedChecks().length)throw new x;if(1!==this.portal.selectedTracks.length)throw new F;var r=1===n.getCheckedChecks().length&&n.tuning.value,o=this.getSelectLayer(t);if(null===o)throw new B;var a=o,l=this.getSecondsPerTick(),s=this.portal.selectedTracks[0],c=this.getStartTime(t),u=function(){return c-(a.inPoint-a.startTime)},_=function(){return void 0!==s?c+s.lengthTick*l:c+t.duration};if(1===this.portal.startTimeCombo.getSelectedIndex())c=a.inPoint;else if(!r)a.startTime=u();var p=Q.getUsingLayering(),h=Q.getOptimizeApplyEffects(),f=Q.getAddToEffectTransform();if(a.timeRemapEnabled)a.timeRemapEnabled=!1;var d=a.source,m=(+(d.duration/d.frameDuration).toFixed(0)-1)*d.frameDuration,E=a.outPoint-a.inPoint-d.frameDuration,O=0,T=function(){return e.getEffects(a).property(O).property(2)};if(n.hMirror.value)O=e.getEffects(a).addProperty("ADBE Mirror").propertyIndex,e.getEffects(a).property(O).property(1).setValue([d.width/2,d.height/2]);var g=0,R={prop:function(){return e.getEffects(a).property(g)},scaleTogether:function(){return this.prop().property(3)},scaleHeight:function(){return this.prop().property(4)},scaleWidth:function(){return this.prop().property(5)},rotation:function(){return this.prop().property(8)}};if(n.hFlip.value||n.cwRotation.value||n.ccwRotation.value){if(n.hFlip.value)a.scale.expressionEnabled=!1;else if(n.cwRotation.value||n.ccwRotation.value)a.rotation.expressionEnabled=!1;if(f)g=this.getGeometry2Effect(a).propertyIndex,R.scaleTogether().setValue(!1)}var y,L=function(e,t){try{e.timeRemap.removeKey(t)}catch(e){}},S=0;if(n.timeRemap.value||n.timeRemap2.value||n.pingpong.value){if(!a.canSetTimeRemapEnabled)throw new G;a.timeRemapEnabled=!0,S=a.timeRemap.valueAtTime(a.inPoint,!1),L(a,2),a.timeRemap.expressionEnabled=!1}if(!r)a.outPoint=_();var v=this.getBasePitch();if(n.tuning.value){if(!a.hasAudio)throw new U;if((y=a.duplicate()).enabled=!1,y.moveAfter(a),y.timeRemapEnabled=!0,!(n.timeRemap.value||n.timeRemap2.value||n.pingpong.value))S=y.timeRemap.valueAtTime(a.inPoint,!1);L(y,2),y.startTime=u(),y.outPoint=_(),y.timeRemap.expressionEnabled=!1,a.audioEnabled=!1}var C=0,N=function(){return e.getEffects(a).property(C).property(2)};if(n.negative.value)C=e.getEffects(a).addProperty("ADBE Invert").propertyIndex,N().setValue(100);var b=0,I=V.NOTE_OFF,A=-1;this.dealNoteEvents(s,t,l,S,(function(e){var t,o;if(!(e.sofarTick<=A)||I===V.NOTE_OFF&&e instanceof _e){var s=e.sofarTick*l+c;if(e instanceof _e){if(0===e.interruptDuration||0===e.duration||+e.interruptDuration<0||+e.duration<0)return;var u=void 0!==e.interruptDuration||void 0!==e.duration,_=null!==(o=null!==(t=e.interruptDuration)&&void 0!==t?t:e.duration)&&void 0!==o?o:0,d=(e.sofarTick+_)*l-me+c;if(n.hFlip.value){var O=function(e){return!f?a.scale.addKey(e):(R.scaleHeight().addKey(e),R.scaleWidth().addKey(e))},g=function(e,t){return!f?a.scale.setValueAtKey(e,t):(R.scaleHeight().setValueAtKey(e,t[1]),R.scaleWidth().setValueAtKey(e,t[0]))},L=function(e,t){return!f?a.scale.setInterpolationTypeAtKey(e,t):(R.scaleHeight().setInterpolationTypeAtKey(e,t),R.scaleWidth().setInterpolationTypeAtKey(e,t))},C=function(e,t,n){return!f?i.setPointKeyEase(a.scale,e,t,n):(i.setPointKeyEase(R.scaleHeight(),e,t,n),i.setPointKeyEase(R.scaleWidth(),e,t,n))},k=O(s),w=b%2?-100:100;if(!h||!u)g(k,[w,100]),L(k,KeyframeInterpolationType.HOLD);else{g(k,[w+15*Math.sign(w),115]),L(k,KeyframeInterpolationType.LINEAR),g(M=O(d),[w,100]),C(M,ee.EASE_IN,!0)}}if(n.cwRotation.value||n.ccwRotation.value){O=function(e){return!f?a.rotation.addKey(e):R.rotation().addKey(e)},g=function(e,t){return!f?a.rotation.setValueAtKey(e,t):R.rotation().setValueAtKey(e,t)},L=function(e,t){return!f?a.rotation.setInterpolationTypeAtKey(e,t):R.rotation().setInterpolationTypeAtKey(e,t)},C=function(e,t,n){return!f?i.setPointKeyEase(a.rotation,e,t,n):i.setPointKeyEase(R.rotation(),e,t,n)};var D=n.cwRotation.value?b%4*90:(4-b%4)%4*90;k=O(s);if(!h||!u)g(k,D),L(k,KeyframeInterpolationType.HOLD);else{g(k,D+15*(n.cwRotation.value?-1:1)),L(k,KeyframeInterpolationType.LINEAR),g(M=O(d),D),C(M,ee.EASE_IN,!0)}}if(n.timeRemap.value||n.timeRemap2.value||n.pingpong.value){k=a.timeRemap.addKey(s);var P=!(b%2);if(a.timeRemap.setValueAtKey(k,S),u){var M=a.timeRemap.addKey(d),x=n.timeRemap.value||n.pingpong.value?S+E:d-s+S,B=n.pingpong.value&&!P;if(B)a.timeRemap.setValueAtKey(k,x);if(x<a.source.duration)a.timeRemap.setValueAtKey(M,!B?x:S);else a.timeRemap.removeKey(M),M=a.timeRemap.addKey(s+m-S),a.timeRemap.setValueAtKey(M,m)}}if(n.negative.value){k=N().addKey(s);N().setValueAtKey(k,b%2?0:100),N().setInterpolationTypeAtKey(k,KeyframeInterpolationType.HOLD)}if(n.hMirror.value){k=T().addKey(s);T().setValueAtKey(k,b%2?0:180),T().setInterpolationTypeAtKey(k,KeyframeInterpolationType.HOLD)}if(n.tuning.value&&y){k=y.timeRemap.addKey(s);if(y.timeRemap.setValueAtKey(k,S),u){M=y.timeRemap.addKey(d);var F=d-s,z=e.pitch-v,G=Math.pow(2,z/12);if((x=F*G+S)<a.source.duration)y.timeRemap.setValueAtKey(M,x);else y.timeRemap.removeKey(M),M=y.timeRemap.addKey(s+(m-S)/G),y.timeRemap.setValueAtKey(M,m)}}if(p&&0!==b){if(!r)a=i.splitLayer(a,s);if(n.tuning.value&&y)y=i.splitLayer(y,s)}b++,I=V.NOTE_ON,A=e.sofarTick}}}))},e.prototype.applyEase100Percent=function(e){app.beginUndoGroup("om midi - Apply Easing 100%");for(var t=this.portal.toolsTab.ease.getValue(),i=0,n=e.selectedLayers;i<n.length;i++){var r=n[i];if(void 0!==r)for(var o=0,a=r.selectedProperties;o<a.length;o++){var l=a[o];if(void 0!==l)for(var s=0,c=l.selectedKeys;s<c.length;s++){var u=c[s];if(void 0!==u)this.setPointKeyEase(l,u,t,!1)}}}},e.prototype.createNullLayer=function(e){var t;e:for(;;){var i=!1;try{i=!!this.nullSource&&!!this.nullSource.parentFolder}catch(e){i=!1}if(i)(t=e.layers.add(this.nullSource,e.workAreaDuration)).opacity.setValue(0),t.anchorPoint.setValue([0,0]);else{for(var n=(t=e.layers.addNull(e.workAreaDuration)).source,r=1;r<=n.parentFolder.items.length;r++){var o=n.parentFolder.items[r];if(o.name===Ee&&o instanceof FootageItem&&o.mainSource instanceof SolidSource){this.nullSource=o,n.remove();continue e}}this.nullSource=n,t.source.name=Ee}break}return t.enabled=!1,t},e.getEffects=function(e){return e("Effects")},e.prototype.addSliderControl=function(t,i){var n=e.getEffects(t).addProperty("ADBE Slider Control");return n.name=i,n.propertyIndex},e.prototype.setValueAtTime=function(t,i,n,r,o,a,l){if(void 0===l)l=a;var s=i.indexOf(n);if(-1!==s){var c=e.getEffects(t).property(s+1).property(1),u=c.addKey(r);c.setValueAtKey(u,o),c.setInterpolationTypeAtKey(u,a,l)}},e.prototype.getSelectLayer=function(e){if(0===e.selectedLayers.length)return null;var t=e.selectedLayers[0];if(t instanceof AVLayer)return t;else return null},e.prototype.getSecondsPerTick=function(){if(!this.portal.midi)throw new M;var e,t=this.portal.midi.timeDivision;if(t instanceof Array)e=1/t[0]/t[1];else{e=60/parseFloat(this.portal.selectBpmTxt.text)/t}return e},e.prototype.getStartTime=function(e){var t=this.portal.startTimeCombo.getSelectedIndex();if(0===t)return e.displayStartTime;else if(1===t)return e.time;else if(2===t)return e.workAreaStart;else return 0},e.prototype.dealNoteEvents=function(e,t,i,n,r){if(void 0!==e)for(var o=0,a=e.events;o<a.length;o++){r(a[o])}else for(var l=0;l*i<=n+t.duration;)r(new _e(60,100,+!!l,1,l++))},e.prototype.getBasePitch=function(){var e=this.portal.applyEffectsTab;return 12*e.basePitchOctCombo.getSelectedIndex()+e.basePitchKeyCombo.getSelectedIndex()},e.prototype.splitLayer=function(e,t){var i=e.outPoint,n=e.duplicate();return e.outPoint=t,n.inPoint=t,n.outPoint=i,n},e.prototype.setPointKeyEase=function(e,t,i,n){for(var r=e.keyInTemporalEase(t).length,o=[],a=0;a<r;a++)o.push(new KeyframeEase(0,100));if(0!==o.length)e.setTemporalEaseAtKey(t,o);var l=n?KeyframeInterpolationType.HOLD:KeyframeInterpolationType.LINEAR;if(i===ee.EASE_IN)e.setInterpolationTypeAtKey(t,KeyframeInterpolationType.BEZIER,l);else if(i===ee.EASE_OUT)e.setInterpolationTypeAtKey(t,l,KeyframeInterpolationType.BEZIER)},e.prototype.getGeometry2Effect=function(t){for(var i="ADBE Geometry2",n=e.getEffects(t),r=1;r<=n.numProperties;r++){var o=n.property(r);if(o.name===Oe&&o.matchName===i)return o}var a=n.addProperty(i);return a.name=Oe,a},e}();!function(e){e[e.EASE_IN=0]="EASE_IN",e[e.EASE_OUT=1]="EASE_OUT",e[e.EASE_IN_OUT=2]="EASE_IN_OUT"}(ee||(ee={}));var ge=function(e){function t(t){var i=e.call(this,t)||this;return i.easeInRadio=n(i.group,"radiobutton",{value:!0}),i.easeOutRadio=n(i.group,"radiobutton"),i.easeInOutRadio=n(i.group,"radiobutton"),i.translate(),i}return l(t,e),t.prototype.getValue=function(){if(this.easeInOutRadio.value)return ee.EASE_IN_OUT;else if(this.easeOutRadio.value)return ee.EASE_OUT;else return ee.EASE_IN},t.prototype.translate=function(){this.easeInRadio.text=localize(p.ease_in),this.easeOutRadio.text=localize(p.ease_out),this.easeInOutRadio.text=localize(p.ease_in_out)},t}(R),Re=function(e){function t(t){var i=e.call(this,t,void 0,{orientation:"column",alignment:"fill",alignChildren:"fill",margins:[10,5,0,0]})||this;return i.toolsCombo=n(i.group,"dropdownlist"),i.toolsCombo.selection=Q.getLastTool(),i.separator=new L(i.group,"horizontal"),i.toolsPanel=n(i.group,"group",{orientation:"stack",alignment:"fill",alignChildren:"fill"}),i.marker=new y(i),i.ease=new ge(i),i.toolsCombo.onChange=function(){for(var e=i.toolsCombo.getSelectedIndex(),t=0;t<i.toolsPanel.children.length;t++){i.toolsPanel.children[t].visible=t===e}Q.setLastTool(i.toolsCombo.getSelectedIndex())},i.toolsCombo.notify("onChange"),i}return l(t,e),t.prototype.getSelectedTool=function(){switch(this.toolsCombo.getSelectedIndex()){case 0:return this.marker;case 1:return this.ease;default:return null}},t.prototype.translate=function(){this.tab.text=localize(p.tools),r(this.toolsCombo,localize(p.marker_conductor),localize(p.easing_100_percent)),this.marker.translate(),this.ease.translate()},t}(E),ye=function(e){function t(t){return e.call(this,Folder.temp.fsName+"/"+(new Date).valueOf()+"_"+t)||this}return l(t,e),t}(File);function Le(e){var t;if(-1!==$.os.indexOf("Win"))t="explorer.exe "+e;else t="open "+e;try{system.callSystem(t)}catch(e){throw new S(e)}}var Se=function(){function e(){if(this.window=new Window("dialog",localize(p.add_at_top_of_expression),void 0,{resizeable:!1}),null===this.window)throw new v;this.group=n(this.window,"group",{orientation:"column",alignChildren:"fill",alignment:"fill"}),n(this.group,"statictext",{text:localize(p.om_utils_same_as_project_directory)}),n(this.group,"edittext",{text:'$.evalFile(thisProject.fullPath.replace(/\\\\[^\\\\]*$/, "/om_utils.jsx"));'},{readonly:!0}),n(this.group,"statictext",{text:localize(p.om_utils_added_to_project)}),n(this.group,"edittext",{text:'footage("om_utils.jsx").sourceData;'},{readonly:!0}),this.okBtn=n(this.group,"button",{text:localize(p.ok),alignment:"right"}),this.window.defaultElement=this.okBtn}return e.prototype.showDialog=function(){this.window.center(),this.window.show()},e}();var ve=function(e){function t(t){var i=e.call(this)||this;return i.file=t,i}return l(t,e),t.prototype.getPointer=function(){return this.file.tell()},t.prototype.length=function(){return this.file.length},t.prototype.readByte=function(e){if(void 0===e)e=1;for(var t=this.file.read(e),i=0,n=0;n<t.length;n++)i<<=8,i+=t.charCodeAt(n);return i},t.prototype.readString=function(e){return this.file.read(e)},t.prototype.readByteArray=function(e){for(var t=this.file.read(e),i=[],n=0;n<t.length;n++)i.push(t.charCodeAt(n));return i},t.prototype.readDeltaTime=function(){for(var e=0,t=!1;!this.isReadOver()&&!t;){e<<=7;var i=this.file.read(1).charCodeAt(0);if(!(128&i))t=!0;e+=127&i}return e},t.prototype.isReadOver=function(){return this.file.eof},t.prototype.movePointer=function(e){this.file.seek(e,1)},t.prototype.setPointer=function(e){if(e<0||e>=this.length())return!1;else return this.file.seek(e,0)},t}((function(){})),Ce=function(){function e(e,t,i){this.events=[],this.noteCount=0,this.lengthTick=0,this.splice=[].splice,this.parent=e,this.offset=t,this.size=i,this.readNotes()}return e.prototype.length=function(){return this.events.length},e.prototype.setName=function(e){var t;null!==(t=this.name)&&void 0!==t||(this.name=e)},e.prototype.setInstrument=function(e){var t;null!==(t=this.instrument)&&void 0!==t||(this.instrument=e)},e.prototype.setChannel=function(e){var t;null!==(t=this.channel)&&void 0!==t||(this.channel=e)},e.prototype.setTempo=function(e){var t,i,n;null!==(t=this.tempo)&&void 0!==t||(this.tempo=e),null!==(i=(n=this.parent.midi).bpm)&&void 0!==i||(n.bpm=this.bpm())},e.prototype.bpm=function(){if(void 0!==this.tempo){var e=6e7/this.tempo;return parseFloat(e.toFixed(2))}},e.prototype.push=function(e){this.events.push(e)},e.prototype.readNotes=function(){for(var e,t=this.offset+this.size,i=[];!(this.parent.isReadOver()||this.parent.getPointer()>=t);){var n=this.parent.readDeltaTime(),r=this.lengthTick+=n,o=e;if(-1===(e=this.parent.readByte(1)))break;else if(!(128&e))e=o,this.parent.movePointer(-1);var a=null;if(255===e){var l=this.parent.readByte(1),s=this.parent.readDeltaTime();switch(l){case H.END_OF_TRACK:if(this.parent.getPointer()!==t)new z(t,this.parent.getPointer());case H.END_OF_FILE:return;case H.TEXT_EVENT:case H.COPYRIGHT_NOTICE:case H.TRACK_NAME:case H.INSTRUMENT_NAME:case H.LYRICS:case H.MARKER:case H.CUE_POINT:var c=this.parent.readString(s);if(a=new re(l,c),l===H.TRACK_NAME)this.setName(c);else if(l===H.INSTRUMENT_NAME)this.setInstrument(c);break;case H.MIDI_PORT:case H.MIDI_PORT_2:case H.KEY_SIGNATURE:case H.SET_TEMPO:var u=this.parent.readByte(s);if(a=new oe(l,u),l===H.SET_TEMPO)this.setTempo(u);break;case H.SMPTE_OFFSET:var _=this.parent.readByteArray(s);a=new ae(_);break;case H.TIME_SIGNATURE:var p=this.parent.readByteArray(s);a=new le(p);break;default:var h=this.parent.readByteArray(s);a=new se(l,h)}}else{this.setChannel(1+(15&e));var f=e>>4;switch(f){case V.NOTE_AFTERTOUCH:case V.CONTROLLER:case V.PITCH_BEND_EVENT:case V.NOTE_OFF:case V.NOTE_ON:var d=this.parent.readByteArray(2);switch(f){case V.NOTE_ON:var m=a=new _e(d);this.noteCount++;for(var E=0,O=i;E<O.length;E++){var T=O[E];if(void 0===T.interruptDuration)if(r<=T.sofarTick)m.interruptDuration=0;else T.interruptDuration=r-T.sofarTick}i.push(m);break;case V.NOTE_OFF:for(var g=a=new pe(d),R=i.length-1;R>=0;R--){if((m=i[R]).pitch===g.pitch){m.duration=r-m.sofarTick,m.noteOff=g,g.noteOn=m,i.splice(R,1);break}}break;case V.CONTROLLER:a=new fe(d);break;case V.PITCH_BEND_EVENT:a=new de(d);break;case V.NOTE_AFTERTOUCH:default:a=new ce(f,d)}break;case V.PROGRAM_CHANGE:case V.CHANNEL_AFTERTOUCH:var y=this.parent.readByteArray(1);a=new ce(f,y);break;case V.END_OF_FILE:return;case V.SYSTEM_EXCLUSIVE_EVENTS:var L=this.parent.readDeltaTime();a=new he(this.parent.readByteArray(L));break;default:throw new A}}if(null!==a)a.deltaTime=n,a.sofarTick=r,this.push(a)}},e.prototype.toString=function(){var e,t=localize(p.channel_abbr)+" "+(null!==(e=this.channel)&&void 0!==e?e:0);if(this.name)t+=": "+this.name;return t+=" ("+this.noteCount+")"},e.prototype.getPointer=function(){return this.parent.getPointer()},e}(),Ne=function(e){function t(t){var i=e.call(this,t.file)||this;return i.midi=t,i.readHeader(),i.readTracks(),i}return l(t,e),t.prototype.readHeader=function(){if(1297377380!==this.readByte(4))throw new b;this.readByte(4),this.midi.formatType=this.readByte(2),this.midi.trackCount=this.readByte(2);var e=this.readByte(1),t=this.readByte(1);if(128&e)this.midi.timeDivision=[127&e,t];else this.midi.timeDivision=(e<<8)+t},t.prototype.readTracks=function(){for(;!this.isReadOver();){var e=this.readByte(4);if(-1===e)break;if(1297379947!==e)throw new I;var t=this.readByte(4),i=new Ce(this,this.getPointer(),t);this.midi.tracks.push(i)}},t}(ve),be=function(){function e(e){if(this.formatType=te.SYNC_MULTI_TRACK,this.trackCount=0,this.timeDivision=0,this.tracks=[],this.preferredTrackIndex=0,this.isPureQuarter=!1,!0===e)return this.isPureQuarter=!0,this.formatType=te.SINGLE_TRACK,this.trackCount=1,void(this.timeDivision=1);if(this.file=e,e&&e.open("r"))e.encoding="binary",this.length=e.length,this.midiReader=new Ne(this),e.close(),this.removeNotNoteTrack(),this.setPreferredTrack(),this.convertTracksNameEncoding();else throw new N}return e.prototype.removeNotNoteTrack=function(){for(var e=this.tracks.length-1;e>=0;e--){if(0===this.tracks[e].noteCount)this.tracks.splice(e,1)}},e.prototype.setPreferredTrack=function(){for(var e=0;e<this.tracks.length;e++){if(10!==this.tracks[e].channel){this.preferredTrackIndex=e;break}}},e.prototype.convertTracksNameEncoding=function(){for(var e=[],t=[],i=0,n=this.tracks;i<n.length;i++){if((o=n[i]).name)e.push(o),t.push(o.name)}if(0!==t.length){t=function(e){if("string"==typeof e)e=[e];if(0===e.length)return[];var t,i=new ye("tmp.txt");if(i&&i.open("w")){t=i.encoding,i.encoding="binary";for(var n=0,r=e;n<r.length;n++){var o=r[n];i.writeln(o)}i.close()}else throw new D;var a=[];if(i&&i.open("r")){for(i.encoding=t;!i.eof;)a.push(i.readln());i.close(),i.remove()}else throw new D;return a}(t);for(var r=0;r<e.length&&r<t.length;r++){var o=e[r],a=t[r].trim();if(""==a)a=void 0;o.name=a}}},e}(),Ie=function(){function e(e,t,i){if(void 0===i)i="fill";this.parent=e,this.outerGroup=n(this.parent,"group",{orientation:"column",alignment:i,alignChildren:"fill"}),this.columns=t}return e.prototype.add=function(e,t,i){var r=this.outerGroup.children;if(0===r.length||r[r.length-1].children.length>=this.columns)this.addRow();return n((r=this.outerGroup.children)[r.length-1],e,t,i)},e.prototype.addRow=function(){n(this.outerGroup,"group",{orientation:"row",alignment:"fill",alignChildren:"left"})},e}(),Ae=function(){function e(i){var a,l=this;if(this.portal=i,this.window=new Window("dialog",localize(p.settings)+" - "+t.scriptName+" v"+t.version,void 0,{resizeable:!1}),null===this.window)throw new v;this.group=n(this.window,"group",{orientation:"row",alignChildren:"fill",alignment:"fill"}),this.leftGroup=n(this.group,"group",{orientation:"column",alignChildren:"fill",alignment:"fill"}),this.separator=new L(this.group,"vertical"),this.rightGroup=n(this.group,"group",{orientation:"column",alignChildren:"fill",alignment:"fill",spacing:5}),this.aboutLbl=n(this.leftGroup,"statictext",{text:localize(p.about,t.githubPage)},{multiline:!0,scrolling:!0}),this.openGithubBtnGroup=new Ie(this.leftGroup,3,["fill","bottom"]),this.openGithubLatestBtn=this.openGithubBtnGroup.add("button",{text:localize(p.check_update)+d}),this.openGithubPageBtn=this.openGithubBtnGroup.add("button",{text:localize(p.repository_link)}),this.extendScriptEngineAboutBtn=this.openGithubBtnGroup.add("button",{text:localize(p.about_script_engine)}),this.importOmUtilsBtn=this.openGithubBtnGroup.add("button",{text:localize(p.import_om_utils)+d}),this.importPureQuarterMidiBtn=this.openGithubBtnGroup.add("button",{text:localize(p.import_pure_quarter_midi)+d}),this.generalPanel=this.addPanel(this.rightGroup,localize(p.general),[10,10,10,7]),a=o(this.generalPanel,localize(p.language),"dropdownlist"),this.languageGroup=a.group,this.languageLbl=a.label,this.languageCombo=a.control,r(this.languageCombo,localize(p.app_default),"简体中文","English","日本語");var s=Q.getLanguage();if(s>0&&s<this.languageCombo.items.length)this.languageCombo.selection=s;this.nullObjPanel=this.addPanel(this.rightGroup,localize(p.create_null_object)),this.usingSelectedLayerName=n(this.nullObjPanel,"checkbox",{text:localize(p.using_selected_layer_name)}),this.usingSelectedLayerName.value=Q.getUsingSelectedLayerName(),this.normalizePanTo100=n(this.nullObjPanel,"checkbox",{text:localize(p.normalize_pan_to_100)}),this.normalizePanTo100.value=Q.getNormalizePanTo100(),this.applyEffectsPanel=this.addPanel(this.rightGroup,localize(p.apply_effects)),this.usingLayering=n(this.applyEffectsPanel,"checkbox",{text:localize(p.using_layering)}),this.usingLayering.value=Q.getUsingLayering(),this.optimizeApplyEffects=n(this.applyEffectsPanel,"checkbox",{text:localize(p.optimize_apply_effects)}),this.optimizeApplyEffects.value=Q.getOptimizeApplyEffects(),this.addToEffectTransform=n(this.applyEffectsPanel,"checkbox",{text:localize(p.add_to_effect_transform)}),this.addToEffectTransform.value=Q.getAddToEffectTransform(),this.buttonGroup=n(this.rightGroup,"group",{orientation:"row",alignment:["fill","bottom"],alignChildren:["right","center"]}),this.okBtn=n(this.buttonGroup,"button",{text:localize(p.ok)}),this.cancelBtn=n(this.buttonGroup,"button",{text:localize(p.cancel)}),this.window.defaultElement=this.okBtn,this.window.cancelElement=this.cancelBtn,this.okBtn.onClick=function(){Q.setUsingSelectedLayerName(l.usingSelectedLayerName.value),Q.setUsingLayering(l.usingLayering.value),Q.setOptimizeApplyEffects(l.optimizeApplyEffects.value),Q.setNormalizePanTo100(l.normalizePanTo100.value),Q.setAddToEffectTransform(l.addToEffectTransform.value),Q.setLanguage(l.languageCombo.getSelectedIndex()),$.locale=e.langIso[l.languageCombo.getSelectedIndex()],l.window.close()},this.openGithubPageBtn.onClick=function(){return Le(t.githubPage)},this.openGithubLatestBtn.onClick=function(){return Le(t.githubLatest)},this.importPureQuarterMidiBtn.onClick=function(){if(confirm(localize(p.sure_to_import_pure_quarter_midi),!0,localize(p.import_pure_quarter_midi)))l.portal.midi=new be(!0),l.portal.selectedTracks=[void 0],l.portal.selectMidiName.text=localize(p.pure_quarter_midi),l.portal.selectTrackBtn.text="",l.portal.selectTrackBtn.enabled=!1,l.portal.selectBpmTxt.enabled=!0},this.importOmUtilsBtn.onClick=function(){return(new Se).showDialog()},this.extendScriptEngineAboutBtn.onClick=function(){return $.about()}}return e.prototype.showDialog=function(){this.window.center(),this.window.show()},e.prototype.addPanel=function(e,t,i){if(void 0===i)i=[10,13,10,3];return n(e,"panel",{text:t,orientation:"column",alignChildren:"fill",alignment:"fill",spacing:2,margins:i})},e.langIso=["","zh_CN","en","ja"],e}(),ke=function(){function e(e){var t=this;if(this.parent=e,this.window=new Window("dialog",localize(p.midi_track_selector_title),void 0,{resizeable:!0}),null===this.window)throw new v;this.window.onResizing=this.window.onResize=function(){return t.window.layout.resize()},this.group=n(this.window,"group",{orientation:"column",alignChildren:"fill",alignment:["fill","fill"]}),this.selectAllCheck=n(this.group,"checkbox",{text:localize(p.select_all)}),this.trackList=n(this.group,"listbox",{alignment:["fill","fill"]},{multiselect:!0,numberOfColumns:4,showHeaders:!0,columnTitles:[localize(p.channel),localize(p.name),localize(p.note_count)],columnWidths:[50,225,75]}),this.trackList.size=[400,400],this.buttonGroup=n(this.group,"group",{orientation:"row",alignment:["fill","bottom"],alignChildren:["right","center"]}),this.okBtn=n(this.buttonGroup,"button",{text:localize(p.ok)}),this.cancelBtn=n(this.buttonGroup,"button",{text:localize(p.cancel)}),this.window.defaultElement=this.okBtn,this.window.cancelElement=this.cancelBtn,this.initMidiTracks(),this.selectAllCheck.onClick=function(){for(var e=t.selectAllCheck.value,i=0,n=t.trackList.items;i<n.length;i++){var r=n[i];r.checked=r.selected=e}},this.trackList.onChange=function(){return t.trackList_onChange()},this.okBtn.onClick=function(){var e;if(t.parent.midi){for(var i=[],n=0;n<t.trackList.items.length;n++){var r=t.trackList.items[n],o=t.parent.midi.tracks[n];if(r.checked)i.push(o)}var a="";if(0!==i.length){if(1===i.length)a=i[0].toString();else{for(var l=[],s=0,c=i;s<c.length;s++){o=c[s];var u=String(null!==(e=o.channel)&&void 0!==e?e:0);if(o.name)u+=": "+o.name;l.push(u)}a=l.join("; ")}t.parent.selectedTracks=i,t.parent.selectTrackBtn.text=a,t.window.close()}else alert(localize(p.select_at_least_one_track),localize(p.warning))}else t.window.close()}}return e.prototype.showDialog=function(){this.window.center(),this.window.show()},e.prototype.initMidiTracks=function(){var e,t;if(this.parent.midi)for(var i=0,n=this.parent.midi.tracks;i<n.length;i++){var r=n[i],o=this.trackList.add("item",String(null!==(e=r.channel)&&void 0!==e?e:0));o.checked=this.parent.selectedTracks.includes(r),o.subItems[0].text=null!==(t=r.name)&&void 0!==t?t:"",o.subItems[1].text=r.noteCount}this.trackList_onChange(!0)},e.prototype.trackList_onChange=function(e){if(void 0===e)e=!1;for(var t=!0,i=0,n=this.trackList.items;i<n.length;i++){var r=n[i];if(!e)r.checked=r.selected;if(!r.checked)t=!1}this.selectAllCheck.value=t},e}(),we=function(e){function t(i,n){if(void 0===n)n="tmp"+(new Date).valueOf()+".png";var r=e.call(this,n)||this;if(r&&r.open("w"))r.encoding="binary",r.write(t.base64Decode(i)),r.close();else throw new D;return r}return l(t,e),t.base64Decode=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i={RE_NON_ALPHA:new RegExp("[^"+t+"]"),RE_BAD_EQUALS:/\=([^=]|\=\=)/},n=e.length>>>0,r=[];if(n%4||i.RE_NON_ALPHA.test(e)||i.RE_BAD_EQUALS.test(e))throw Error("Invalid Base64 data");for(var o,a,l,s,c,u,_=0;_<n;){if(s=((l=(t.indexOf(e[_++])<<18)+(t.indexOf(e[_++])<<12)+((63&(o=t.indexOf(e[_++])))<<6)+(63&(a=t.indexOf(e[_++]))))&255<<16)>>16,c=64==o?-1:(65280&l)>>8,u=64==a?-1:255&l,r[r.length]=String.fromCharCode(s),0<=c)r[r.length]=String.fromCharCode(c);if(0<=u)r[r.length]=String.fromCharCode(u)}return e=r.join(""),r.length=0,e},t.settingIcon=function(){return new t("iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAEMklEQVRIib1WTUgjWRCudeemiK4N4iy6GjYHESHYZC8yvqcEVvxBUEQvUcQQzOYayDALe3IGc1ToGQysoBdJBvUQVi9BXoSAkDQEg+QQiBsRvXQiO8bAHpYsX6c7ZESduewWNP3yut6rqq/qq8o3jDH6Smk11G6/9kAsFqMXWAghnlTinPuIyCNJkgW/NU2DgY9E9EEIkXrmXHWBCCqVyqMPY0z2+XwVTdMqptzf31disViFMbb51DnjrH7/iy9E6Z6cnNQXGxsb+ttms9HQ0BBZrVY35zwghMg9d0HNAOe8GVAQEaCICiEAg9zT00Pn5+e0v78fxH46nQ7DQH9/P2WzWZlzDsjcRo4+CiHURw0Q0ZrX6/W0t7dTKpWCd6okSXJbWxudnp7iew5GOee5QqFgsVqt2PNLkhSem5ujpqYmOj4+9nPOXUKI32u3AivG2NutrS0d5cvLy9ob2OM9MzMDzFsNbP3hcLimg5zgMXUZY0nG2A9mDlCmrZIkFXd2dvSyCgQCqt1ul0dGRqhUKlEoFELluIhIMmCIEtH09PS0B1GYOpC6OwJE9BprGPB7vd618fFxWlhYwGXdxmWzRs03S5L0xoRBVVWKRqMwgpzIhg7Wfgg8Hxsbw953MICQw8lkUg/R5XIhxLd1pfYecACCeslkMiZsw4aeDWV7eHioa6G0UeJmDoahbOJpfPSZHICg7mEceuvr67oenIJzjLFmXA4dCByCY2YOvu3u7v6zXC5fHRwcfD8wMPByYmKCwuHwj8B7ZWVFBiwejydXLBZHyuXym0wm809LS8srh8NB8Xi8r1gs/uX1elE9wB75+AD8iejvfD5PDVRtFSirQDweJ5Sl0RZ0DpTLZajcoi0IIYBt6ubmRvcOXIAjcKJQKCA3qhDiFyHEp894wDlfBskGBwd1RU3TwE714uJC7uvr0y/hnNuIKA8yd3R06IfT6bRuHJXU2dlJDocDxHtvRPDJhGhYkqS9zc3Nl11dXbS6ukrX19fviGivVCq5p6amyGKxtF5dXa00NDT4R0dHX83Pz9PZ2Rnt7u6C7b8lEok2i8UiO51OamxstCcSiRYi+gMQ/edVBIjUXC4329vbS7e3eqsPcs4dRIQnryjKu1Ao9BQPfuac/2Ss9cPIWSKRwFo1DQRDoZBOtOXlZVTCHrCUZfkzJiuK8pDJ4Tomr5ltRydX1eD/04vMifYr5xzl5gEM29vbesmhm6K/AB5FUdCS0WPc6FNHR0d634IOvqMLRyIRMiZd3pxo9e36taIoeRMGIUSUc54sFAoyDmNOcM5n7Xa7BVzJZrPYC2iaFjWMgzvBJ+eBQY7Ag4FU48Li4qL77u7ObcwBkwMgFhL68NyjA+cxCUYiETcYvbS0VPt+cnKCCODts+PyiwYQLiaU0+nEv4pqd6z+s0CVoOc8L0T0L32CI0/szYESAAAAAElFTkSuQmCC","settings_icon.png")},t}(ye),De=function(){function e(e){var t,i,r,a,l=this;this.selectedTracks=[],this.window=e,this.group=n(this.window,"group",{orientation:"column",alignChildren:"fill",alignment:"fill",spacing:5});var s=["fill","center"];t=o(this.group,"","button",{text:"...",size:[15,22]}),this.selectMidiGroup=t.group,this.selectMidiLbl=t.label,this.selectMidiBtn=t.control,this.selectMidiName=n(this.selectMidiGroup,"statictext",{alignment:s}),i=o(this.group,"","button",{text:"",alignment:s,maximumSize:[1e4,22],enabled:!1}),this.selectTrackGroup=i.group,this.selectTrackLbl=i.label,this.selectTrackBtn=i.control,r=o(this.group,"","edittext",{text:"120",alignment:s,enabled:!1}),this.selectBpmGroup=r.group,this.selectBpmLbl=r.label,this.selectBpmTxt=r.control,a=o(this.group,"","dropdownlist",{alignment:s}),this.startTimeGroup=a.group,this.startTimeLbl=a.label,this.startTimeCombo=a.control,this.tabs=n(this.group,"tabbedpanel",{alignment:["fill","fill"]}),this.buttonGroup=n(this.group,"group",{orientation:"row",alignment:["fill","bottom"]}),this.applyBtn=n(this.buttonGroup,"button",{alignment:"left"});var c=we.settingIcon();this.settingBtn=n(this.buttonGroup,"iconbutton",{alignment:["right","center"],image:c},{style:"toolbutton"}),c.remove(),this.nullObjTab=new O(this),this.applyEffectsTab=new T(this),this.toolsTab=new Re(this),this.translate(),this.core=new Te(this),g(this.selectBpmTxt,f.POSITIVE_DECIMAL,120),this.selectMidiBtn.onClick=function(){var e,t=File.openDialog(localize(p.select_a_midi_file),localize(p.midi_files)+":*.mid;*.midi,"+localize(p.all_files)+":*.*");if(null!==t){var i;try{if((i=new be(t)).bpm)l.selectBpmTxt.text=String(i.bpm);if(0===i.tracks.length)throw new k;l.selectMidiName.text=t.displayName;var n=i.tracks[i.preferredTrackIndex];l.selectedTracks=[n],l.selectTrackBtn.text=n.toString(),l.selectTrackBtn.enabled=!0,l.selectBpmTxt.enabled=!0,l.midi=i}catch(t){if(i)null===(e=i.file)||void 0===e||e.close();throw new S(t)}}},this.applyBtn.onClick=function(){return l.core.apply()},this.settingBtn.onClick=function(){var e;if(new Ae(l).showDialog(),null===(e=l.midi)||void 0===e?void 0:e.isPureQuarter)l.selectTrackBtn.enabled=!1;l.translate()},this.selectTrackBtn.onClick=function(){new ke(l).showDialog()},this.tabs.onChange=function(){if(l.getSelectedTab()===l.applyEffectsTab)l.startTimeCombo.selection=Q.getApplyEffectsStartTime();else l.startTimeCombo.selection=Q.getNullObjectStartTime()},this.tabs.onChange(),this.startTimeCombo.onChange=function(){var e=l.getSelectedTab(),t=l.startTimeCombo.getSelectedIndex();if(e===l.applyEffectsTab)Q.setApplyEffectsStartTime(t);else Q.setNullObjectStartTime(t)}}return e.build=function(t,i){$.strict=!0;var n=t instanceof Panel?t:new Window("palette",i.scriptName+" v"+i.version,void 0,{resizeable:!0});if(null===n)throw new v;var r=new e(n);if(n.onShow=n.onResizing=n.onResize=function(){return n.layout.resize()},n instanceof Window)n.center(),n.show();else n.layout.layout(!0),n.layout.resize();return r},e.prototype.getSelectedTab=function(){if(null===this.tabs.selection)return null;switch(this.tabs.selection.text){case this.nullObjTab.tab.text:return this.nullObjTab;case this.applyEffectsTab.tab.text:return this.applyEffectsTab;case this.toolsTab.tab.text:return this.toolsTab;default:return null}},e.prototype.translate=function(){if(this.applyBtn.text=localize(p.apply),this.nullObjTab.translate(),this.applyEffectsTab.translate(),this.toolsTab.translate(),!this.midi||!this.selectedTracks.length)this.selectMidiName.text=localize(p.no_midi_file_selected);this.selectMidiLbl.text=localize(p.select_midi_file),this.selectTrackLbl.text=localize(p.select_midi_track),this.selectBpmLbl.text=localize(p.set_midi_bpm),this.startTimeLbl.text=localize(p.start_time),r(this.startTimeCombo,localize(p.display_start_time),localize(p.current_time),localize(p.work_area),"0")},e}();if("aftereffects"!==BridgeTalk.appName)throw new w;else String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1},Array.prototype.includes=function(e){return-1!==this.indexOf(e)},DropDownList.prototype.getSelectedIndex=function(){for(var e=0;e<this.items.length;e++)if(this.items[e].selected)return e;return-1},Math.sign=function(e){if(e>0)return 1;else if(e<0)return-1;else return 0},De.build(e,t)}(this);
